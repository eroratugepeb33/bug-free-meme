name: Tailscale RDP macOS Setup

on:
  workflow_dispatch:
    inputs:
      tailscale_auth_key:
        description: 'Tailscale Auth Key'
        required: true
        type: string
      tailscale_tags:
        description: 'Tailscale Tags (comma separated)'
        required: false
        default: 'tag:server'
        type: string
      enable_vnc:
        description: 'Enable VNC access'
        required: false
        default: false
        type: boolean

jobs:
  setup-tailscale-rdp:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Tailscale
        run: |
          # Download the official Tailscale package
          curl -L -o tailscale.pkg https://pkgs.tailscale.com/stable/Tailscale-latest-macos.pkg
          
          # Install the package
          echo "Installing Tailscale package..."
          sudo installer -pkg tailscale.pkg -target /
          
          # Clean up
          rm tailscale.pkg
          
          # Check what was installed
          echo "Checking installation..."
          ls -la /Applications/ | grep -i tailscale || echo "No Tailscale app in /Applications"
          find /usr/local -name "*tailscale*" 2>/dev/null || echo "No Tailscale in /usr/local"
          find /opt -name "*tailscale*" 2>/dev/null || echo "No Tailscale in /opt"
          which tailscale 2>/dev/null || echo "tailscale not in PATH"
          
          # Wait for installation to complete
          sleep 15

      - name: Configure Tailscale
        run: |
          echo "Searching for Tailscale binaries..."
          
          # Search in multiple locations
          TAILSCALE_PATH=$(find /Applications /usr/local /opt -name "tailscale" -type f 2>/dev/null | head -1)
          TAILSCALED_PATH=$(find /Applications /usr/local /opt -name "tailscaled" -type f 2>/dev/null | head -1)
          
          # Check standard locations if not found
          if [ -z "$TAILSCALE_PATH" ]; then
            for path in \
              "/Applications/Tailscale.app/Contents/MacOS/Tailscale" \
              "/usr/local/bin/tailscale" \
              "/opt/homebrew/bin/tailscale" \
              "/usr/bin/tailscale"; do
              if [ -f "$path" ]; then
                TAILSCALE_PATH="$path"
                break
              fi
            done
          fi
          
          if [ -z "$TAILSCALED_PATH" ]; then
            for path in \
              "/Applications/Tailscale.app/Contents/MacOS/tailscaled" \
              "/usr/local/bin/tailscaled" \
              "/opt/homebrew/bin/tailscaled" \
              "/usr/sbin/tailscaled"; do
              if [ -f "$path" ]; then
                TAILSCALED_PATH="$path"
                break
              fi
            done
          fi
          
          echo "Found Tailscale binary: $TAILSCALE_PATH"
          echo "Found Tailscaled binary: $TAILSCALED_PATH"
          
          # Verify binaries exist
          if [ ! -f "$TAILSCALE_PATH" ]; then
            echo "ERROR: Tailscale binary not found at $TAILSCALE_PATH"
            exit 1
          fi
          
          if [ ! -f "$TAILSCALED_PATH" ]; then
            echo "ERROR: Tailscaled binary not found at $TAILSCALED_PATH"
            exit 1
          fi
          
          echo "Binaries verified successfully"
          
          # Start Tailscale service
          sudo "$TAILSCALED_PATH" &
          
          # Wait for daemon to start
          sleep 10
          
          # Connect to Tailscale network
          echo "${{ inputs.tailscale_auth_key }}" | sudo "$TAILSCALE_PATH" up \
            --auth-key="$(cat)" \
            --hostname="github-actions-mac-${GITHUB_RUN_ID}" \
            --advertise-tags="${{ inputs.tailscale_tags }}" \
            --accept-routes=true \
            --accept-dns=true \
            --ssh

      - name: Enable Remote Desktop (Screen Sharing)
        run: |
          # Enable Screen Sharing (VNC/RDP equivalent on macOS)
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate \
            -configure -access -on \
            -configure -allowAccessFor -allUsers \
            -configure -restart -agent
            
          # Set remote management access
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts -setvnclegacy -vnclegacy yes
            
          # Set VNC password (using a default password - change this for production)
          echo "Setting VNC password"
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts -setvncpw -vncpw "githubactions123"

      - name: Configure Firewall
        if: ${{ inputs.enable_vnc }}
        run: |
          # Allow VNC through firewall
          sudo /usr/libexec/ApplicationFirewall/socketfilterfw --setglobalstate on
          sudo /usr/libexec/ApplicationFirewall/socketfilterfw --add /System/Library/CoreServices/RemoteManagement/ARDAgent.app
          sudo /usr/libexec/ApplicationFirewall/socketfilterfw --unblockapp /System/Library/CoreServices/RemoteManagement/ARDAgent.app

      - name: Display Connection Info
        run: |
          # Use the full path to tailscale binary
          TAILSCALE_PATH=$(find /Applications /usr/local -name "tailscale" -type f 2>/dev/null | head -1)
          if [ -z "$TAILSCALE_PATH" ]; then
            TAILSCALE_PATH="/Applications/Tailscale.app/Contents/MacOS/Tailscale"
          fi
          
          echo "=== Tailscale RDP Setup Complete ==="
          echo "Machine hostname: github-actions-mac-${GITHUB_RUN_ID}"
          echo ""
          echo "Tailscale IP addresses:"
          "$TAILSCALE_PATH" ip -4
          "$TAILSCALE_PATH" ip -6
          echo ""
          echo "To connect via VNC:"
          echo "1. Install a VNC client (RealVNC, TightVNC, etc.)"
          echo "2. Connect to the Tailscale IP shown above"
          echo "3. Use password: githubactions123"
          echo ""
          TAILSCALE_IP=$("$TAILSCALE_PATH" ip -4)
          echo "To connect via SSH:"
          echo "ssh $(whoami)@$TAILSCALE_IP"
          echo ""
          echo "Note: This runner will be available until the job completes."
          echo "The workflow will timeout after 6 hours by default."

      - name: Keep alive
        run: |
          # Keep the workflow running to maintain the connection
          echo "Workflow will remain active for remote access..."
          echo "Press Ctrl+C or wait for timeout to end session"
          
          # Sleep in background to keep workflow alive
          sleep 21600 &  # 6 hours
          wait
